---
title: "Covid-19 flexdashboard + leaflet"
author: "Martin Frigaard"
date: "compiled on `r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
library(flexdashboard)
library(readr)
library(leaflet)
library(DT)
library(tidyverse)
library(lubridate)
library(plotly)
library(usmap)
library(spData)
library(ggmap)
library(hrbrthemes)
library(geofacet)
library(socviz)
# figs folder
fs::dir_create("figs/")
# data folder
fs::dir_create("data/")
# docs folder
fs::dir_create("docs/")
knitr::opts_chunk$set(
  echo = TRUE,
  cache = FALSE,
  prompt = FALSE,
  tidy = FALSE,
  fig.width = 10,
  fig.height = 8,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  fig.path = "figs/"
)
knitr::opts_knit$set(
  width = 78
)
base::options(
  tibble.print_max = 25,
  tibble.width = 78,
  scipen = 100000000,
  max.print = 99999
)
ggplot2::theme_set(hrbrthemes::theme_ipsum_tw(
  base_size = 9,
  strip_text_size = 11,
  axis_title_size = 14,
  plot_title_size = 17,
  subtitle_size = 14,
  base_family = "Ubuntu",
  # "JosefinSans-LightItalic"
  strip_text_family = "TitilliumWeb-Regular",
  axis_title_family = "TitilliumWeb-Regular",
  subtitle_family = "TitilliumWeb-Regular",
  plot_title_family = "JosefinSans-Regular"
))
```

# Data for maps with `geofacet`

This covers making a geocoded map from the [Johns Hopkins data from their dashboard](https://github.com/CSSEGISandData/COVID-19).

```{r 01.0-import-wrangle}
# source("code/01.0-import-wrangle.R")
```


### Graph CSSE Deaths per day (May)

Here is the total number of deaths from `2020-05-01` until `2020-05-31`.

```{r}
CSSEDailyCovid19 %>% glimpse()
```


```{r geofacet-death_quantiles-day-deaths, fig.width = 10, fig.height=8}
CSSEDailyCovid19 %>% 
    dplyr::mutate(`death quantiles` = fct_rev(as_factor(death_quantiles))) %>% 
    dplyr::filter(date >= as.Date("2020-05-01") & 
                      date <= as.Date("2020-05-31")) %>% 
    ggplot2::ggplot(aes(x = day, 
                        y = deaths, 
                        group = `death quantiles`)) +
    ggplot2::geom_point(aes(color = `death quantiles`), 
                        show.legend = FALSE) + 
    ggplot2::geom_line(aes(color = `death quantiles`)) +
    geofacet::facet_geo(~ state, 
                        grid = "us_state_grid2",
                        scales = "free_y") +
    ggplot2::scale_color_brewer(palette = "RdBu") +
    ggplot2::labs(title = "Total number of COVID-19 deaths", 
                subtitle = "from: 2020-05-01 - 2020-05-31")
```

## Graph confirmed cases per day (May 01 - May 15)

This narrows the range to confirmed cases between May 1 and May 15. 

```{r date-confirmed}
CSSEDailyCovid19 %>% 
    dplyr::filter(date >= as.Date("2020-05-01") & 
                      date <= as.Date("2020-05-15")) %>% 
    ggplot2::ggplot(aes(x = date, 
                        y = confirmed)) +
    ggplot2::geom_point() + 
    ggplot2::geom_line() + 
    geofacet::facet_geo(~ state, 
                        grid = "us_state_grid1",
                        scales = "free_y") +
  ggplot2::labs(title = "Total number of confirmed COVID-19 cases (2020-05-01 - 2020-05-16)")
```


## Graph state-level indicators 

```{r geofacet-indicators}
TidyStateIndicators %>% 
# this can be a toggle in the dashboard!
 # dplyr::filter(indicator %in% c("testing rate", "incident rate")) %>%
  dplyr::filter(indicator %in% c("mortality rate", "hospitalization rate")) %>%
    # dplyr::filter(indicator %in% c("incident rate", "hospitalization rate")) %>%
    # dplyr::filter(indicator %in% c("testing rate", "mortality rate")) %>%
    ggplot(aes(x = indicator, 
               y = rate, 
               fill = indicator)) +
  ggplot2::geom_col() +
  ggplot2::coord_flip() +
  geofacet::facet_geo(~ province_state, 
                      grid = "us_state_grid2",
                      move_axes = TRUE) +
  ggplot2::labs(x = NULL,
                y = "Rates",
                title = "State-level COVID Rates")
```

## Graph state-level counts

```{r geofacet-measures}
TidyStateCounts %>% 
# this can be a toggle in the dashboard!
 # dplyr::filter(measure %in% c("active", "confirmed")) %>%
  # dplyr::filter(measure %in% c("people tested", "recovered")) %>%
    # dplyr::filter(measure %in% c("confirmed", "deaths")) %>%
      # dplyr::filter(measure %in% c("recovered", "confirmed")) %>%
       dplyr::filter(measure %in% c("people tested", "confirmed")) %>%
    ggplot(aes(x = measure, 
               y = count, 
               fill = measure)) +
  ggplot2::geom_col() +
  ggplot2::coord_flip() +
  geofacet::facet_geo(~ province_state, 
                      grid = "us_state_grid2",
                      move_axes = TRUE) +
  ggplot2::labs(x = NULL,
                y = "Rates",
                title = "State-level COVID Raw Counts")
```

## Graph CSSE Mortality rates (May)

```{r geofacet-day-mortality_rate}
CSSEDailyCovid19 %>% 
    dplyr::mutate(`mortality rate cut-offs` = fct_rev(as_factor(mortal_rate_bin))) %>% 
    dplyr::filter(date >= as.Date("2020-05-01") & 
                      date < as.Date("2020-05-31")) %>% 
    # dplyr::filter(state %in% c("MD", "NV")) %>% 
    ggplot2::ggplot(aes(x = day, 
                        y = mortality_rate,
                        group = `mortality rate cut-offs`)) +
    ggplot2::geom_point(aes(color = `mortality rate cut-offs`)) + 
    ggplot2::geom_line(aes(group = state)) +
    geofacet::facet_geo(~ state, 
                        grid = "us_state_grid2",
                        scales = "free_y") + 
    ggplot2::labs(title = "COVID-19 mortality rates",
                  subtitle = "from (2020-05-01 - 2020-05-31)") 
```

### Graph CSSE Tidy indicators (May)

```{r may_indicators}
may_indicators <- sort(unique(TidyCSSEIndicatorsMay$indicator))
```


```{r goefacet-hospitalization-mortality}
TidyCSSEIndicatorsMay %>% 
    # dplyr::filter(indicator %in% may_indicators[c(1,2)]) %>% 
    dplyr::filter(indicator %in% may_indicators[c(1,3)]) %>%
    # dplyr::filter(indicator %in% may_indicators[c(1,4)]) %>%
    # dplyr::filter(indicator %in% may_indicators[c(2,3)]) %>%
    # dplyr::filter(indicator %in% may_indicators[c(3,4)]) %>%
    ggplot(aes(x = indicator, 
               y = rate, 
               fill = indicator)) +
  ggplot2::geom_col() +
  ggplot2::coord_flip() +
  geofacet::facet_geo(~ state) 
```



